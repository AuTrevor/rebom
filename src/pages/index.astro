---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SevenDayOutlook from "../components/SevenDayOutlook.svelte";
import Map from "../components/Map.svelte";
import Warnings from "../components/Warnings.svelte";
import IntroCard from "../components/IntroCard.svelte";
import Hero from "../components/Hero.svelte";
import HourlyScroll from "../components/HourlyScroll.svelte";
import { getIconFromCode } from "../lib/weather/icons";

// Get city from URL parameter, default to Sydney
const cityName = Astro.url.searchParams.get("city") || "Sydney";

import { getCityWeatherRaw } from "../lib/server/weather";
import { transformWeatherData, WeatherService } from "../lib/services/weather";
import type { WeatherData } from "../lib/types/weather";

let weatherData: WeatherData | null = null;
let errorMessage = null;

// Try to fetch directly from DB first (Server-side) to avoid self-fetch 522 errors
// @ts-ignore
const db = Astro.locals.runtime?.env?.DB;

if (db) {
    try {
        const rawData = await getCityWeatherRaw(db, cityName);
        if (rawData) {
            weatherData = transformWeatherData(rawData);
        } else {
            console.warn(`Weather data not found for city: ${cityName}`);
        }
    } catch (e) {
        console.error("Error fetching weather server-side:", e);
    }
} else {
    // Fallback for local dev if DB binding is missing (though platformProxy should handle it)
    console.warn("DB not available in Astro.locals, falling back to fetch");
    const weatherService = new WeatherService(Astro.url.origin);
    weatherData = await weatherService.getCityWeather(cityName);
}

if (!weatherData) {
    errorMessage = "Unable to connect to weather service";
}
---

<Layout>
    <Header />

    <main class="container mx-auto px-4 py-8 min-h-screen">
        <!-- Loading State -->
        <div id="loading-state" class="hidden flex flex-col items-center justify-center py-20">
             <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-slate-600 font-medium">Initializing system data...</p>
            <p class="text-sm text-slate-400">This may take a moment</p>
        </div>

        {errorMessage && (
            <div id="error-state" class="mb-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Error: </strong>
                <span class="block sm:inline">{errorMessage}</span>
            </div>
        )}
        
        {weatherData && (
            <>
            <Warnings client:load warnings={weatherData.warnings} />

            <IntroCard client:load>
                <div class="max-w-4xl mx-auto px-4 py-16 text-center">
    <h1 class="text-4xl md:text-6xl font-extrabold mb-4 tracking-tight">
        Built for $12.50.
    </h1>
    <h2 class="text-xl md:text-2xl text-gray-600 mb-10 max-w-2xl mx-auto">
        We saved the other <span class="text-green-600 font-mono font-bold">$96,499,987.50</span> for a rainy day.
    </h2>
    
    <div class="bg-white rounded-2xl border border-gray-200 shadow-xl overflow-hidden grid md:grid-cols-2 text-left">
        
        <div class="p-8 border-b md:border-b-0 md:border-r border-gray-100 bg-gray-50/50">
            <p class="font-bold text-lg mb-2 text-gray-900">Why so cheap?</p>
            <p class="text-gray-600">
                Sure, we skipped the $12m security audit. </p><p>Nobody wants to hack a site that just says "It's Sunny."
            </p>
        </div>

        <div class="p-8 flex flex-col justify-center bg-white">
            <p class="font-bold text-lg mb-2 text-gray-900">Current Status</p>
            <div>
                <span class="inline-flex items-center bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full">
                    ⚠️ BETA MODE
                </span>
                <p class="text-xs text-gray-500 mt-2">Adding features faster than government procurement.</p>
            </div>
        </div>
    </div>
</div>
            </IntroCard>

        <!-- Hero Section -->
        <div class="mb-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <Hero 
                client:load 
                location={weatherData.location} 
                current={weatherData.current} 
                metadata={weatherData.metadata} 
                forecast={weatherData.forecast} 
            />
            <HourlyScroll client:load />
        </div>

        <!-- Map Section -->
        <div class="mb-8 bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4">Location</h3>
            <div class="h-96 rounded-xl overflow-hidden relative z-0">
                <Map 
                    client:only="svelte" 
                    lat={weatherData.location.lat} 
                    lon={weatherData.location.lon} 
                    locationName={weatherData.location.name} 
                />
            </div>
        </div>

        <!-- 7-Day Outlook -->
        <SevenDayOutlook client:visible forecast={weatherData.forecast} />

        </>
        )}
    </main>

    <script define:vars={{ hasWeatherData: !!weatherData }}>
        if (!hasWeatherData) {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');

            // Show loading, hide error initially
            if (loadingState) loadingState.classList.remove('hidden');
            if (errorState) errorState.classList.add('hidden');

            fetch('/api/system/startup')
                .then(res => res.json())
                .then(data => {
                    if (data.ingested) {
                        // Reload to get data
                        window.location.reload();
                    } else {
                        // No ingestion happened, so the error is real
                        if (loadingState) loadingState.classList.add('hidden');
                        if (errorState) errorState.classList.remove('hidden');
                    }
                })
                .catch(e => {
                    console.error("Startup check failed", e);
                    if (loadingState) loadingState.classList.add('hidden');
                    if (errorState) errorState.classList.remove('hidden');
                });
        }
    </script>

    <Footer />
</Layout>
